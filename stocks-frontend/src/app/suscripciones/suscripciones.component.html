<div class="app">
  <aside class="sidebar">
    <div class="logo">PlazApp Admin</div>
    <nav class="nav">
      <a href="/">üè† Dashboard</a>
      <a href="/modulos">üß© M√≥dulos</a>
      <a href="/planes">üì¶ Planes</a>
      <a href="/plazas">üè¢ Plazas</a>
      <a href="/suscripciones" class="active">üîÅ Suscripciones</a>
    </nav>
    <div style="margin-top:auto;font-size:13px;color:#cfcfcf">¬© KodeHaus</div>
  </aside>

  <div class="container">
    <header class="header">
      <div style="margin-right:12px;text-align:right">
        <div class="small">Admin Entidad de Gobierno</div>
      </div>
      <div class="avatar" title="Admin"></div>
    </header>
    <main class="content">
      <div class="page-header">
        <h2>Gesti√≥n de Suscripciones</h2>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="loadSuscripciones()" [disabled]="loading">
            <span *ngIf="loading">üîÑ</span>
            <span *ngIf="!loading">üîÑ</span>
            Actualizar
          </button>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
        <button (click)="errorMessage = ''" class="close-error">√ó</button>
      </div>

      <!-- Success Message -->
      <div *ngIf="successMessage" class="success-message">
        {{ successMessage }}
        <button (click)="successMessage = ''" class="close-success">√ó</button>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando suscripciones...</p>
      </div>

      <!-- Main Content -->
      <div *ngIf="!loading" class="main-content">
        <!-- Suscripciones List -->
        <div class="suscripciones-section">
          <div class="section-header">
            <h3>Lista de Suscripciones</h3>
            <span class="count">{{ suscripciones.length }} suscripciones</span>
          </div>
          
          <div class="suscripciones-grid">
            <div 
              *ngFor="let suscripcion of suscripciones" 
              class="suscripcion-card"
              [class.selected]="selectedSuscripcion?.id === suscripcion.id"
              (click)="selectSuscripcion(suscripcion)">
              
              <div class="card-header">
                <div class="plan-info">
                  <h4>{{ suscripcion.plan.tipo }}</h4>
                  <span class="plan-price">${{ suscripcion.plan.precio | number:'1.2-2' }}</span>
                </div>
                <div class="status-badge" [ngClass]="getEstadoClass(suscripcion.estado)">
                  {{ suscripcion.estado }}
                </div>
              </div>

              <div class="card-body">
                <div class="info-row">
                  <span class="label">Plaza:</span>
                  <span class="value">{{ suscripcion.plaza.nombre }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Periodicidad:</span>
                  <span class="value">{{ suscripcion.periodicidad }}</span>
                </div>
                <div class="info-row">
                  <span class="label">M√≥dulos:</span>
                  <span class="value">{{ (suscripcion.modulos?.length || 0) }} / {{ suscripcion.plan.numModulos }}</span>
                </div>
                <div class="info-row">
                  <span class="label">√öltimo pago:</span>
                  <span class="value">{{ formatDate(suscripcion.fechaUltimoPago) }}</span>
                </div>
                <div class="info-row">
                  <span class="label">Renovaci√≥n:</span>
                  <span class="value">{{ formatDate(suscripcion.fechaRenovacion) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Suscripcion Details -->
        <div *ngIf="selectedSuscripcion" class="details-section">
          <div class="section-header">
            <h3>Detalles de Suscripci√≥n</h3>
            <button class="btn btn-primary" (click)="openAddModulosModal()">
              ‚ûï Agregar M√≥dulos
            </button>
          </div>

          <div class="details-card">
            <div class="details-header">
              <div class="plan-details">
                <h4>{{ selectedSuscripcion.plan.tipo }}</h4>
                <div class="plan-specs">
                  <span class="spec">${{ selectedSuscripcion.plan.precio | number:'1.2-2' }}</span>
                  <span class="spec">{{ selectedSuscripcion.plan.numModulos }} m√≥dulos</span>
                  <span class="spec">{{ selectedSuscripcion.plan.numUsuarios }} usuarios</span>
                </div>
              </div>
              <div class="plaza-details">
                <h5>{{ selectedSuscripcion.plaza.nombre }}</h5>
                <p>{{ selectedSuscripcion.plaza.ubicacion.ciudad }}, {{ selectedSuscripcion.plaza.ubicacion.pais }}</p>
                <p>{{ selectedSuscripcion.plaza.contacto }}</p>
              </div>
            </div>

            <div class="modulos-section">
              <h5>M√≥dulos Activos ({{ selectedSuscripcion.modulos?.length || 0 }})</h5>
              <div class="modulos-grid">
                <div *ngFor="let modulo of (selectedSuscripcion.modulos || [])" class="modulo-item">
                  <div class="modulo-info">
                    <span class="modulo-name">{{ modulo.nombre }}</span>
                    <span class="modulo-status" [ngClass]="'status-' + modulo.estado.toLowerCase()">
                      {{ modulo.estado }}
                    </span>
                  </div>
                  <button 
                    class="btn btn-danger btn-sm" 
                    (click)="removeModuloFromSuscripcion(modulo.id)"
                    title="Eliminar m√≥dulo">
                    üóëÔ∏è
                  </button>
                </div>
                <div *ngIf="!selectedSuscripcion.modulos || selectedSuscripcion.modulos.length === 0" class="empty-state">
                  <p>No hay m√≥dulos asignados a esta suscripci√≥n</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Modulos Modal -->
  <div *ngIf="showAddModulosModal" class="modal-overlay" (click)="closeAddModulosModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Agregar M√≥dulos</h3>
        <button class="close-btn" (click)="closeAddModulosModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <p>Selecciona los m√≥dulos que deseas agregar a la suscripci√≥n:</p>
        
        <div class="available-modulos">
          <div *ngFor="let modulo of availableModulos" class="modulo-option">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                [value]="modulo.id"
                (change)="toggleModuloSelection(modulo.id)"
                [checked]="selectedModulos.includes(modulo.id)">
              <span class="checkmark"></span>
              <div class="modulo-details">
                <span class="modulo-name">{{ modulo.nombre }}</span>
                <span class="modulo-status" [ngClass]="'status-' + modulo.estado.toLowerCase()">
                  {{ modulo.estado }}
                </span>
              </div>
            </label>
          </div>
        </div>

        <div *ngIf="availableModulos.length === 0" class="empty-state">
          <p>No hay m√≥dulos disponibles para agregar</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddModulosModal()">
          Cancelar
        </button>
        <button 
          class="btn btn-primary" 
          (click)="addModulosToSuscripcion()"
          [disabled]="selectedModulos.length === 0">
          Agregar {{ selectedModulos.length }} m√≥dulo(s)
        </button>
      </div>
    </div>
  </div>
</div>